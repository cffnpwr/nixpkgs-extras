name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow_ref }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  list-packages:
    name: List Packages
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v21
        with:
          extra-conf: |
            extra-substituters = https://nix-cache.cffnpwr.dev
            extra-trusted-public-keys = cffnpwr-nixpkgs-extras:dmp2DUGwdqawLCPOsOcRxU/NpCO/qA1jha/8rmoSzvA=

      - name: List all packages
        run: |
          nix search .#legacyPackages '^'

  detect-changes:
    name: Detect Changed Packages
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
    outputs:
      build_all: ${{ steps.detect.outputs.build_all }}
      changed_packages: ${{ steps.detect.outputs.changed_packages }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Detect changes
        id: detect
        env:
          GH_EVENT_NAME: ${{ github.event_name }}
        run: |
          # Build all packages on push to main
          if [[ "$GH_EVENT_NAME" == "push" ]]; then
            echo "build_all=true" >> "$GITHUB_OUTPUT"
            echo "changed_packages=[]" >> "$GITHUB_OUTPUT"
            echo "Push to main detected, building all packages"
            exit 0
          fi

          # Get changed files compared to main
          changed_files=$(git diff --name-only origin/main...HEAD)
          echo "Changed files:"
          echo "$changed_files"

          # Check if flake.nix or flake.lock changed
          if echo "$changed_files" | grep -qE '^flake\.(nix|lock)$'; then
            echo "build_all=true" >> "$GITHUB_OUTPUT"
            echo "changed_packages=[]" >> "$GITHUB_OUTPUT"
            echo "flake.nix or flake.lock changed, building all packages"
            exit 0
          fi

          # Extract changed package names from pkgs/<package-name>/
          changed_packages=$(echo "$changed_files" | grep -oE '^pkgs/[^/]+/' | sed 's|pkgs/||; s|/$||' | grep -v '^overlays$' | sort -u)

          if [[ -z "$changed_packages" ]]; then
            echo "build_all=false" >> "$GITHUB_OUTPUT"
            echo "changed_packages=[]" >> "$GITHUB_OUTPUT"
            echo "No package changes detected"
          else
            # Convert to JSON array
            json_array=$(echo "$changed_packages" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "build_all=false" >> "$GITHUB_OUTPUT"
            echo "changed_packages=$json_array" >> "$GITHUB_OUTPUT"
            echo "Changed packages: $json_array"
          fi

  generate-matrix:
    name: Generate Build Matrix
    needs: detect-changes
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_packages: ${{ steps.set-matrix.outputs.has_packages }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v21
        with:
          extra-conf: |
            extra-substituters = https://nix-cache.cffnpwr.dev
            extra-trusted-public-keys = cffnpwr-nixpkgs-extras:dmp2DUGwdqawLCPOsOcRxU/NpCO/qA1jha/8rmoSzvA=

      - name: Generate matrix
        id: set-matrix
        env:
          BUILD_ALL: ${{ needs.detect-changes.outputs.build_all }}
          CHANGED_PACKAGES: ${{ needs.detect-changes.outputs.changed_packages }}
        run: |
          # Get full matrix from Nix
          full_matrix=$(nix run .#generate-github-actions-matrix)

          if [[ "$BUILD_ALL" == "true" ]]; then
            echo "Building all packages"
            matrix="$full_matrix"
          else
            echo "Filtering to changed packages: $CHANGED_PACKAGES"
            # Filter matrix to only include changed packages
            # For packages like microsoft-office.excel, check if microsoft-office is in changed_packages
            # For packages like swiftPackages.sourcekitd-inproc or python3Packages.pybit7z,
            # also match against any segment of the dotted package name
            matrix=$(echo "$full_matrix" | jq -c --argjson changed "$CHANGED_PACKAGES" '
              .include |= map(
                select(
                  .package as $pkg |
                  $changed | any(. as $c |
                    $pkg == $c or
                    ($pkg | startswith($c + ".")) or
                    ($pkg | split(".") | last == $c)
                  )
                )
              )
            ')
          fi

          # Check if matrix has any packages
          has_packages=$(echo "$matrix" | jq '.include | length > 0')
          echo "has_packages=$has_packages" >> "$GITHUB_OUTPUT"
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"
          echo "Matrix: $matrix"

  build-packages:
    name: Build ${{ matrix.package }} (${{ matrix.system }})
    needs: generate-matrix
    if: needs.generate-matrix.outputs.has_packages == 'true'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 300
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v21
        with:
          extra-conf: |
            ssl-cert-file = /etc/ssl/certs/ca-certificates.crt
            extra-substituters = https://nix-cache.cffnpwr.dev
            extra-trusted-public-keys = cffnpwr-nixpkgs-extras:dmp2DUGwdqawLCPOsOcRxU/NpCO/qA1jha/8rmoSzvA=

      - name: Build ${{ matrix.package }} for ${{ matrix.system }}
        id: build
        env:
          PACKAGE: ${{ matrix.package }}
          SYSTEM: ${{ matrix.system }}
        run: |
          out=$(nix build ".#$PACKAGE" --print-build-logs --system "$SYSTEM" --print-out-paths)
          echo "out=$out" >> "$GITHUB_OUTPUT"

      - name: Upload to Cloudflare R2 cache
        if: github.event_name == 'push'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          NIX_SECRET_KEY: ${{ secrets.NIX_SECRET_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          OUT: ${{ steps.build.outputs.out }}
        run: |-
          # Write signing key to temp file (unique path to avoid conflicts between parallel jobs)
          key_file=$(mktemp)
          trap 'rm -f "$key_file"' EXIT
          echo "$NIX_SECRET_KEY" > "$key_file"

          # List all paths in the closure using the actual build output path
          paths=$(nix path-info --recursive "$OUT")

          if [ -z "$paths" ]; then
            echo "No paths found in closure, skipping upload."
            exit 0
          fi

          # Filter out paths already in cache.nixos.org (parallel, limited to CPU core count)
          num_cpus=$(nproc 2>/dev/null || sysctl -n hw.logicalcpu)
          paths_to_upload=$(echo "$paths" | xargs -P"$num_cpus" -I{} sh -c \
            'nix path-info --store https://cache.nixos.org/ "{}" &>/dev/null || echo "{}"')

          if [ -z "$paths_to_upload" ]; then
            echo "All paths already exist in cache.nixos.org, skipping upload."
            exit 0
          fi

          echo "Uploading $(echo "$paths_to_upload" | wc -l | tr -d ' ') paths to R2..."
          # shellcheck disable=SC2086
          nix copy \
            --no-check-sigs \
            --to "s3://${R2_BUCKET}?endpoint=${R2_ENDPOINT}&region=auto&compression=zstd&parallel-compression=true&secret-key=${key_file}" \
            $paths_to_upload
