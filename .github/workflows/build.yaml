name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow_ref }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  list-packages:
    name: List Packages
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v21

      - name: List all packages
        run: |
          nix search .#legacyPackages '^'

  detect-changes:
    name: Detect Changed Packages
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
    outputs:
      build_all: ${{ steps.detect.outputs.build_all }}
      changed_packages: ${{ steps.detect.outputs.changed_packages }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Detect changes
        id: detect
        env:
          GH_EVENT_NAME: ${{ github.event_name }}
        run: |
          # Build all packages on push to main
          if [[ "$GH_EVENT_NAME" == "push" ]]; then
            echo "build_all=true" >> "$GITHUB_OUTPUT"
            echo "changed_packages=[]" >> "$GITHUB_OUTPUT"
            echo "Push to main detected, building all packages"
            exit 0
          fi

          # Get changed files compared to main
          changed_files=$(git diff --name-only origin/main...HEAD)
          echo "Changed files:"
          echo "$changed_files"

          # Check if flake.nix or flake.lock changed
          if echo "$changed_files" | grep -qE '^flake\.(nix|lock)$'; then
            echo "build_all=true" >> "$GITHUB_OUTPUT"
            echo "changed_packages=[]" >> "$GITHUB_OUTPUT"
            echo "flake.nix or flake.lock changed, building all packages"
            exit 0
          fi

          # Extract changed package names from pkgs/<package-name>/
          changed_packages=$(echo "$changed_files" | grep -oE '^pkgs/[^/]+/' | sed 's|pkgs/||; s|/$||' | grep -v '^overlays$' | sort -u)

          if [[ -z "$changed_packages" ]]; then
            echo "build_all=false" >> "$GITHUB_OUTPUT"
            echo "changed_packages=[]" >> "$GITHUB_OUTPUT"
            echo "No package changes detected"
          else
            # Convert to JSON array
            json_array=$(echo "$changed_packages" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "build_all=false" >> "$GITHUB_OUTPUT"
            echo "changed_packages=$json_array" >> "$GITHUB_OUTPUT"
            echo "Changed packages: $json_array"
          fi

  generate-matrix:
    name: Generate Build Matrix
    needs: detect-changes
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_packages: ${{ steps.set-matrix.outputs.has_packages }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v21

      - name: Generate matrix
        id: set-matrix
        env:
          BUILD_ALL: ${{ needs.detect-changes.outputs.build_all }}
          CHANGED_PACKAGES: ${{ needs.detect-changes.outputs.changed_packages }}
        run: |
          # Get full matrix from Nix
          full_matrix=$(nix run .#generate-github-actions-matrix)

          if [[ "$BUILD_ALL" == "true" ]]; then
            echo "Building all packages"
            matrix="$full_matrix"
          else
            echo "Filtering to changed packages: $CHANGED_PACKAGES"
            # Filter matrix to only include changed packages
            # For packages like microsoft-office.excel, check if microsoft-office is in changed_packages
            # For packages like swiftPackages.sourcekitd-inproc or python3Packages.pybit7z,
            # also match against any segment of the dotted package name
            matrix=$(echo "$full_matrix" | jq -c --argjson changed "$CHANGED_PACKAGES" '
              .include |= map(
                select(
                  .package as $pkg |
                  $changed | any(. as $c |
                    $pkg == $c or
                    ($pkg | startswith($c + ".")) or
                    ($pkg | split(".") | last == $c)
                  )
                )
              )
            ')
          fi

          # Check if matrix has any packages
          has_packages=$(echo "$matrix" | jq '.include | length > 0')
          echo "has_packages=$has_packages" >> "$GITHUB_OUTPUT"
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"
          echo "Matrix: $matrix"

  build-packages:
    name: Build ${{ matrix.package }} (${{ matrix.system }})
    needs: generate-matrix
    if: needs.generate-matrix.outputs.has_packages == 'true'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v21
        with:
          extra-conf: |
            sandbox = false
            ssl-cert-file = /etc/ssl/certs/ca-certificates.crt

      - name: Build ${{ matrix.package }} for ${{ matrix.system }}
        env:
          PACKAGE: ${{ matrix.package }}
          SYSTEM: ${{ matrix.system }}
        run: nix build ".#$PACKAGE" --print-build-logs --system "$SYSTEM"
